From 971be9a47119d24711e9de60c3066d41e4254108 Mon Sep 17 00:00:00 2001
From: Mio <mio@mio19.uk>
Date: Thu, 13 Nov 2025 18:43:10 +1100
Subject: [PATCH] Disable-FLAG_SECURE

https://github.com/VarunS2002/Xposed-Disable-FLAG_SECURE/blob/f35b4c31f7bc593c4d8142d86885b8a35ef5708b/app/src/main/java/com/varuns2002/disable_flag_secure/DisableFlagSecure.kt
on Android 16 do not have:

WindowManagerGlobal.addView(View, LayoutParams, Display, Window) (4-arg), and

WindowManagerService.isSecureLocked(WindowState),
---
 core/java/android/view/SurfaceView.java                   | 2 +-
 core/java/android/view/Window.java                        | 2 +-
 core/java/android/view/WindowManagerGlobal.java           | 8 ++++----
 services/core/java/com/android/server/wm/WindowState.java | 2 +-
 4 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/core/java/android/view/SurfaceView.java b/core/java/android/view/SurfaceView.java
index 29008d31990d..ece7831a8e3e 100644
--- a/core/java/android/view/SurfaceView.java
+++ b/core/java/android/view/SurfaceView.java
@@ -923,7 +923,7 @@ public class SurfaceView extends View implements ViewRootImpl.SurfaceChangedCall
      * @param isSecure True if the surface view is secure.
      */
     public void setSecure(boolean isSecure) {
-        if (isSecure) {
+        if (false) {
             mSurfaceFlags |= SurfaceControl.SECURE;
         } else {
             mSurfaceFlags &= ~SurfaceControl.SECURE;
diff --git a/core/java/android/view/Window.java b/core/java/android/view/Window.java
index df23556a2672..6a25ffbe4d2a 100644
--- a/core/java/android/view/Window.java
+++ b/core/java/android/view/Window.java
@@ -1305,7 +1305,7 @@ public abstract class Window {
      * @see #clearFlags
      */
     public void setFlags(int flags, int mask) {
-        final WindowManager.LayoutParams attrs = getAttributes();
+        flags &= ~WindowManager.LayoutParams.FLAG_SECURE; final WindowManager.LayoutParams attrs = getAttributes();
         attrs.flags = (attrs.flags&~mask) | (flags&mask);
         mForcedWindowFlags |= mask;
         dispatchWindowAttributesChanged(attrs);
diff --git a/core/java/android/view/WindowManagerGlobal.java b/core/java/android/view/WindowManagerGlobal.java
index 5fdb387c0f73..02b9cd01add2 100644
--- a/core/java/android/view/WindowManagerGlobal.java
+++ b/core/java/android/view/WindowManagerGlobal.java
@@ -383,7 +383,7 @@ public final class WindowManagerGlobal {
     }
 
     public void addView(View view, ViewGroup.LayoutParams params,
-            Display display, Window parentWindow, int userId) {
+            Display display, Window parentWindow, int userId) { //
         if (view == null) {
             throw new IllegalArgumentException("view must not be null");
         }
@@ -394,7 +394,7 @@ public final class WindowManagerGlobal {
             throw new IllegalArgumentException("Params must be WindowManager.LayoutParams");
         }
 
-        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;
+        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params; wparams.flags &= ~WindowManager.LayoutParams.FLAG_SECURE;
         final Context context = view.getContext();
         if (parentWindow != null) {
             parentWindow.adjustLayoutParamsForSubWindow(wparams);
@@ -501,7 +501,7 @@ public final class WindowManagerGlobal {
         }
     }
 
-    public void updateViewLayout(View view, ViewGroup.LayoutParams params) {
+    public void updateViewLayout(View view, ViewGroup.LayoutParams params) { //
         if (view == null) {
             throw new IllegalArgumentException("view must not be null");
         }
@@ -509,7 +509,7 @@ public final class WindowManagerGlobal {
             throw new IllegalArgumentException("Params must be WindowManager.LayoutParams");
         }
 
-        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams)params;
+        final WindowManager.LayoutParams wparams = (WindowManager.LayoutParams)params; wparams.flags &= ~WindowManager.LayoutParams.FLAG_SECURE;
 
         view.setLayoutParams(wparams);
 
diff --git a/services/core/java/com/android/server/wm/WindowState.java b/services/core/java/com/android/server/wm/WindowState.java
index d5c1721183fe..0a8058a84cfc 100644
--- a/services/core/java/com/android/server/wm/WindowState.java
+++ b/services/core/java/com/android/server/wm/WindowState.java
@@ -1803,7 +1803,7 @@ class WindowState extends WindowContainer<WindowState> implements WindowManagerP
                && mActivityRecord.getActivityType() == ACTIVITY_TYPE_DREAM;
     }
 
-    boolean isSecureLocked() {
+    boolean isSecureLocked() { if (true) { return false; }
         if (mWmService.getDisableSecureWindows()) {
             return false;
         }
-- 
2.51.0

